# Release Workflow - Finalize, Build, Test, and Publish
#
# Unified release workflow that handles the complete release process:
# 1. Validate: Check all prerequisites (PR status, CI passed, CHANGELOG ready)
# 2. Finalize: Set release date in CHANGELOG, trigger PR doc sync
# 3. Build & Test: Build and test images for all architectures
# 4. Publish: Create tag and publish images only if all tests pass
# 5. Rollback (on failure): Revert changes and create issue
#
# Design: Everything happens in one workflow dispatch before creating the tag.
# This ensures no broken releases are tagged.

name: Release

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      version:
        description: 'Semantic version to release (e.g., 1.2.3)'
        required: true
        type: string
      dry-run:
        description: 'Validate without making changes'
        required: false
        default: false
        type: boolean
      git-user-name:
        description: 'Git user name for commits'
        required: false
        default: 'vigOS Release Bot'
        type: string
      git-user-email:
        description: 'Git user email for commits'
        required: false
        default: 'release@vig-os.local'
        type: string

concurrency:
  # Prevent multiple releases from running simultaneously (race conditions on tags/manifests)
  group: publish-image
  cancel-in-progress: false

permissions:
  contents: read     # safe default; jobs escalate as needed

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    outputs:
      version: ${{ steps.vars.outputs.version }}
      pr_number: ${{ steps.pr.outputs.pr_number }}
      release_date: ${{ steps.vars.outputs.release_date }}
      build_timestamp: ${{ steps.vars.outputs.build_timestamp }}
      release_url: ${{ steps.vars.outputs.release_url }}
      pre_finalize_sha: ${{ steps.pre_sha.outputs.pre_finalize_sha }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Validate and prepare variables
        id: vars
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          VERSION="$INPUT_VERSION"

          # Validate semantic version format
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "ERROR: Invalid version format '$VERSION'"
            echo "Version must follow semantic versioning format: MAJOR.MINOR.PATCH (e.g., 1.2.3)"
            exit 1
          fi

          RELEASE_BRANCH="release/$VERSION"
          RELEASE_DATE=$(date -u +%Y-%m-%d)
          BUILD_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          RELEASE_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/$VERSION"

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "release_date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT
          echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "release_branch=$RELEASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Checkout release branch
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          git fetch origin "release/$VERSION" || {
            echo "ERROR: Release branch not found: release/$VERSION"
            echo "Did you run: just prepare-release $VERSION"
            exit 1
          }
          git checkout "origin/release/$VERSION"

      - name: Record pre-finalization SHA
        id: pre_sha
        run: |
          PRE_FINALIZE_SHA=$(git rev-parse HEAD)
          echo "pre_finalize_sha=$PRE_FINALIZE_SHA" >> $GITHUB_OUTPUT
          echo "Pre-finalization SHA: $PRE_FINALIZE_SHA"

      - name: Verify CHANGELOG has TBD entry
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          if ! grep -q "## \[$VERSION\] - TBD" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md does not contain '## [$VERSION] - TBD'"
            exit 1
          fi

      - name: Verify tag does not exist
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          if git tag -l | grep -q "^${VERSION}$"; then
            echo "ERROR: Tag $VERSION already exists"
            exit 1
          fi

      - name: Set up GitHub CLI
        run: |
          gh version
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find and verify PR
        id: pr
        env:
          VERSION: ${{ steps.vars.outputs.version }}
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          RELEASE_BRANCH="release/$VERSION"

          # Find PR from release branch to main
          PR_JSON=$(gh pr list \
            --head "$RELEASE_BRANCH" \
            --base main \
            --json number,isDraft,reviewDecision,statusCheckRollup \
            --limit 1)

          PR_COUNT=$(echo "$PR_JSON" | jq 'length')

          if [ "$PR_COUNT" != "1" ]; then
            if [ "$PR_COUNT" = "0" ]; then
              echo "ERROR: No PR found from $RELEASE_BRANCH to main"
              exit 1
            else
              echo "ERROR: Multiple PRs found from $RELEASE_BRANCH to main"
              exit 1
            fi
          fi

          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.[0].number')
          IS_DRAFT=$(echo "$PR_JSON" | jq -r '.[0].isDraft')
          REVIEW_DECISION=$(echo "$PR_JSON" | jq -r '.[0].reviewDecision')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ "$IS_DRAFT" = "true" ]; then
            echo "ERROR: PR #$PR_NUMBER is still in draft status"
            echo "Mark it ready for review first: gh pr ready $PR_NUMBER"
            exit 1
          fi

          if [ "$REVIEW_DECISION" != "APPROVED" ]; then
            echo "ERROR: PR #$PR_NUMBER does not have approvals (status: $REVIEW_DECISION)"
            exit 1
          fi

          # Check CI status
          STATUS_ROLLUP=$(echo "$PR_JSON" | jq -r '.[0].statusCheckRollup // []')
          CI_FAILED=$(echo "$STATUS_ROLLUP" | jq '[.[] | select(.conclusion == "FAILURE" or .conclusion == "ERROR")] | length')

          if [ "$CI_FAILED" != "0" ]; then
            echo "ERROR: PR #$PR_NUMBER has failed CI checks"
            echo "Fix CI issues before releasing"
            exit 1
          fi

          # Check that at least some checks have passed
          CI_SUCCESS=$(echo "$STATUS_ROLLUP" | jq '[.[] | select(.conclusion == "SUCCESS")] | length')
          if [ "$CI_SUCCESS" = "0" ]; then
            echo "ERROR: PR #$PR_NUMBER has no successful CI checks"
            echo "Ensure CI has run on the release branch"
            exit 1
          fi

          echo "✓ PR #$PR_NUMBER verified: ready and approved"

      - name: Summary
        env:
          VERSION: ${{ steps.vars.outputs.version }}
          PR_NUMBER: ${{ steps.pr.outputs.pr_number }}
          RELEASE_DATE: ${{ steps.vars.outputs.release_date }}
          DRY_RUN: ${{ github.event.inputs.dry-run }}
        run: |
          echo "✓ All validation checks passed"
          echo ""
          echo "Release Configuration:"
          echo "  Version: $VERSION"
          echo "  Release Branch: release/$VERSION"
          echo "  PR: #$PR_NUMBER"
          echo "  Release Date: $RELEASE_DATE"
          echo "  Dry-run: $DRY_RUN"

  finalize:
    name: Finalize Release
    needs: validate
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    if: ${{ github.event.inputs.dry-run != 'true' }}
    permissions:
      contents: write    # read release branch (fetch/reset)
      actions: write     # trigger sync-issues workflow
    outputs:
      finalize_sha: ${{ steps.finalize.outputs.finalize_sha }}

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.APP_SYNC_ISSUES_ID }}
          private-key: ${{ secrets.APP_SYNC_ISSUES_PRIVATE_KEY }}

      - name: Checkout release branch
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          ref: release/${{ needs.validate.outputs.version }}
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Set up environment
        uses: ./.github/actions/setup-env
        with:
          sync-dependencies: 'true'

      - name: Set release date in CHANGELOG
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          RELEASE_DATE: ${{ needs.validate.outputs.release_date }}
        run: |
          set -euo pipefail
          uv run prepare-changelog finalize "$VERSION" "$RELEASE_DATE"
          echo "✓ Release date set in CHANGELOG.md"

      - name: Commit and push finalization changes via API
        uses: vig-os/commit-action@b70c2d87acd0f146c40e8d88a9bda40b76c084b5  # v0.1.3
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TARGET_BRANCH: refs/heads/release/${{ needs.validate.outputs.version }}
          COMMIT_MESSAGE: |-
            chore: finalize release ${{ needs.validate.outputs.version }}

            Set release date to ${{ needs.validate.outputs.release_date }} in CHANGELOG.md

            Refs: #${{ needs.validate.outputs.pr_number }}
          FILE_PATHS: CHANGELOG.md

      - name: Trigger sync-issues workflow
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          set -euo pipefail
          echo "Triggering sync-issues workflow..."
          gh workflow run sync-issues.yml \
            -f "target-branch=release/$VERSION"
          echo "✓ sync-issues workflow triggered"

      - name: Wait for sync-issues completion
        run: |
          set -euo pipefail
          TIMEOUT=120
          ELAPSED=0
          INTERVAL=10

          sleep 5
          ELAPSED=5

          while [ $ELAPSED -lt $TIMEOUT ]; do
            RUN_STATUS=$(gh run list \
              --workflow sync-issues.yml \
              --limit 1 \
              --json status,conclusion \
              --jq '.[0].status' 2>/dev/null || echo "unknown")

            if [ "$RUN_STATUS" = "completed" ]; then
              RUN_CONCLUSION=$(gh run list \
                --workflow sync-issues.yml \
                --limit 1 \
                --json conclusion \
                --jq '.[0].conclusion' 2>/dev/null || echo "unknown")

              if [ "$RUN_CONCLUSION" = "success" ]; then
                echo "✓ sync-issues workflow completed successfully"
              else
                echo "⚠ sync-issues workflow completed with status: $RUN_CONCLUSION"
              fi
              break
            fi

            sleep "$INTERVAL"
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "Waiting for sync-issues... (${ELAPSED}s / ${TIMEOUT}s)"
          done

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "⚠ Timed out waiting for sync-issues workflow"
            echo "The release may continue, but PR documentation may not be synced"
          fi

        env:
          GH_TOKEN: ${{ github.token }}

      - name: Pull sync-issues changes
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          set -euo pipefail
          git fetch origin "release/$VERSION"
          git reset --hard "origin/release/$VERSION"
          echo "✓ Synced with remote release branch"

      - name: Output finalize SHA
        id: finalize
        run: |
          FINALIZE_SHA=$(git rev-parse HEAD)
          echo "finalize_sha=$FINALIZE_SHA" >> $GITHUB_OUTPUT
          echo "Finalized at commit: $FINALIZE_SHA"

  build-and-test:
    name: Build and Test
    needs: [validate, finalize]
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    # TODO: implement build and test steps

    steps:
      - name: Checkout release commit
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          ref: ${{ needs.finalize.outputs.finalize_sha }}

  publish:
    name: Publish Release
    needs: [validate, finalize, build-and-test]
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      contents: write       # create and push tags

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.APP_SYNC_ISSUES_ID }}
          private-key: ${{ secrets.APP_SYNC_ISSUES_PRIVATE_KEY }}

      - name: Checkout release commit
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          ref: ${{ needs.finalize.outputs.finalize_sha }}
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Configure git
        env:
          GIT_USER_NAME: ${{ github.event.inputs.git-user-name }}
          GIT_USER_EMAIL: ${{ github.event.inputs.git-user-email }}
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

      - name: Create annotated tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          set -euo pipefail
          git tag -a "$VERSION" -m "Release $VERSION"
          echo "✓ Tag created: $VERSION"

      - name: Push tag
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          git push origin "$VERSION"
          echo "✓ Tag pushed"

      - name: Summary
        env:
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          echo "✓ Release published successfully!"

  rollback:
    name: Rollback on Failure
    needs: [validate, finalize, build-and-test, publish]
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    if: failure()
    permissions:
      issues: write          # create failure issue

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.APP_SYNC_ISSUES_ID }}
          private-key: ${{ secrets.APP_SYNC_ISSUES_PRIVATE_KEY }}

      - name: Rollback release branch
        id: rollback-branch
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          VERSION: ${{ needs.validate.outputs.version }}
          PRE_SHA: ${{ needs.validate.outputs.pre_finalize_sha }}
        run: |
          set -euo pipefail
          echo "Rolling back release branch to pre-finalization state..."
          gh api "repos/${{ github.repository }}/git/refs/heads/release/$VERSION" \
            -X PATCH \
            -f sha="$PRE_SHA" \
            -F force=true
          echo "✓ Release branch rolled back to $PRE_SHA"

      - name: Delete tag if created
        id: rollback-tag
        continue-on-error: true
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          VERSION: ${{ needs.validate.outputs.version }}
        run: |
          set -euo pipefail
          TAG="$VERSION"
          if gh api "repos/${{ github.repository }}/git/refs/tags/$TAG" >/dev/null 2>&1; then
            echo "Deleting remote tag: $TAG"
            gh api "repos/${{ github.repository }}/git/refs/tags/$TAG" -X DELETE
            echo "✓ Tag deleted"
          else
            echo "Tag does not exist on remote (not created)"
          fi

      - name: Create failure issue
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7
        with:
          script: |
            const version = '${{ needs.validate.outputs.version }}';
            const workflowUrl = `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`;
            const prNumber = ${{ needs.validate.outputs.pr_number || 'null' }};

            let failedJobs = [];
            if ('${{ needs.validate.result }}' !== 'success') failedJobs.push('validate');
            if ('${{ needs.finalize.result }}' !== 'success') failedJobs.push('finalize');
            if ('${{ needs.build-and-test.result }}' !== 'success') failedJobs.push('build-and-test');
            if ('${{ needs.publish.result }}' !== 'success') failedJobs.push('publish');

            const rollbackBranch = '${{ steps.rollback-branch.outcome }}';
            const rollbackTag = '${{ steps.rollback-tag.outcome }}';

            const title = `Release ${version} failed -- automatic rollback`;
            const body = `
            Release ${version} encountered an error during the automated release workflow.

            **Failed Jobs:** ${failedJobs.join(', ')}

            **Workflow Run:** [View logs](${workflowUrl})

            **Release PR:** #${prNumber}

            **Rollback Results:**
            - Branch rollback: ${rollbackBranch}
            - Tag deletion: ${rollbackTag}

            **Actions Taken:**
            - Release branch rolled back to pre-finalization state
            - Release tag deleted (if created)
            - This issue created for investigation

            **Next Steps:**
            1. Review the workflow logs to identify the root cause
            2. Check rollback results above; fix any partial rollback manually
            3. Fix the issue on the release branch
            4. Re-run the workflow when ready

            For details, check the workflow run linked above.
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
              labels: ['bug', 'release']
            });

            console.log(`Created issue: ${title}`);

      - name: Summary
        run: |
          echo "✗ Release workflow failed"
          echo ""
          echo "Automatic rollback completed:"
          echo "  - Release branch reset to pre-finalization state"
          echo "  - Release tag deleted (if created)"
          echo "  - GitHub issue created for investigation"
          echo ""
          echo "Check the workflow logs and issue for details"

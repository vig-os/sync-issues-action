# Post-Release â€” Sync dev with main after merge
#
# Triggered automatically when a PR is merged into main.
# Keeps the dev branch in sync by merging main back into dev.
#
# After a release merge (release/X.Y.Z -> main):
#   - Merges main into dev
#   - Resets CHANGELOG Unreleased section for next cycle
#
# After any other merge to main (e.g., hotfix):
#   - Merges main into dev
#   - CHANGELOG reset is skipped (only release branches need it)
#
# NOTE: GitHub Actions does not support a "merged" filter on pull_request
# triggers. This fires on every closed PR targeting main; the job-level `if`
# condition below correctly skips runs where the PR was closed without merging.
#
# Refs: https://github.com/vig-os/sync-issues-action/issues/13
# Refs: https://github.com/vig-os/sync-issues-action/issues/52 (sync via PR for branch protection)

name: Post-Release

on:  # yamllint disable-line rule:truthy
  pull_request:
    types: [closed]
    branches: [main]
  workflow_dispatch:
    inputs:
      git-user-name:
        description: 'Git user name for commits'
        required: false
        default: 'github-actions[bot]'
        type: string
      git-user-email:
        description: 'Git user email for commits'
        required: false
        default: '41898282+github-actions[bot]@users.noreply.github.com'
        type: string
      reset-changelog:
        description: 'Reset CHANGELOG Unreleased section (for re-run after release)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read       # safe default; sync-dev job escalates as needed

jobs:
  sync-dev:
    name: Sync dev with main
    runs-on: ubuntu-22.04
    timeout-minutes: 10
    permissions:
      contents: write       # push to sync branch
      pull-requests: write  # create and merge PR into dev (branch protection)
      actions: write        # allow downstream workflow triggers
    if: >-
      ${{ github.event_name == 'workflow_dispatch'
       || github.event.pull_request.merged == true }}

    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf  # v2
        with:
          app-id: ${{ secrets.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}

      - name: Checkout dev branch
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: dev
          fetch-depth: 0
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: true

      - name: Configure git
        env:
          GIT_USER_NAME: ${{ inputs.git-user-name || 'github-actions[bot]' }}
          GIT_USER_EMAIL: ${{ inputs.git-user-email || '41898282+github-actions[bot]@users.noreply.github.com' }}
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

      - name: Merge main into dev
        run: |
          set -euo pipefail
          git fetch origin main
          if git merge origin/main --no-edit; then
            echo "Merged main into dev"
          else
            echo "ERROR: Merge conflict merging main into dev"
            echo ""
            echo "Manual resolution required:"
            echo "  git checkout dev"
            echo "  git pull origin dev"
            echo "  git merge origin/main"
            echo "  # resolve conflicts..."
            echo "  git commit"
            echo "  git push origin dev"
            exit 1
          fi

      - name: Reset CHANGELOG for next cycle
        id: reset-changelog
        if: >-
          (github.event_name == 'pull_request' && startsWith(github.event.pull_request.head.ref, 'release/'))
          || (github.event_name == 'workflow_dispatch' && inputs.reset-changelog == true)
        run: |
          set -euo pipefail
          python3 .github/prepare_changelog.py reset CHANGELOG.md
          echo "CHANGELOG Unreleased section reset"
          echo "reset=true" >> $GITHUB_OUTPUT

      - name: Commit and push to sync branch
        id: sync-push
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          SYNC_BRANCH: "sync/dev-from-main-${{ github.run_id }}"
        run: |
          set -euo pipefail

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit (dev already in sync)"
            echo "pushed=false" >> $GITHUB_OUTPUT
          else
            COMMIT_MSG="chore: sync dev with main after merge"
            if [ -n "${PR_NUMBER:-}" ]; then
              COMMIT_MSG=$(printf '%s\n\nRefs: #%s' "$COMMIT_MSG" "$PR_NUMBER")
            fi
            git commit -m "$COMMIT_MSG"
            git checkout -b "$SYNC_BRANCH"
            git push -u origin "$SYNC_BRANCH"
            echo "pushed=true" >> $GITHUB_OUTPUT
            echo "branch=$SYNC_BRANCH" >> $GITHUB_OUTPUT
            echo "Changes committed and pushed to $SYNC_BRANCH"
          fi

      - name: Create PR into dev
        id: create-pr
        if: steps.sync-push.outputs.pushed == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          SYNC_BRANCH: ${{ steps.sync-push.outputs.branch }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euo pipefail

          BODY="Syncs \`dev\` with \`main\` after merge (post-release workflow)."
          if [ -n "${PR_NUMBER:-}" ]; then
            BODY="$BODY

          Refs: #${PR_NUMBER}"
          fi

          PR_URL=$(gh pr create \
            --base dev \
            --head "$SYNC_BRANCH" \
            --title "chore: sync dev with main after merge" \
            --body "$BODY")
          PR_NO=$(echo "$PR_URL" | sed -n 's|.*/pull/\([0-9]*\)|\1|p')
          echo "number=$PR_NO" >> $GITHUB_OUTPUT
          echo "PR #$PR_NO: $PR_URL"

      - name: Summary
        env:
          EVENT_NAME: ${{ github.event_name }}
          CHANGELOG_RESET: ${{ steps.reset-changelog.outcome }}
          SYNC_PUSHED: ${{ steps.sync-push.outputs.pushed }}
          PR_NUMBER: ${{ steps.create-pr.outputs.number }}
        run: |
          echo "Post-release sync complete"
          echo ""
          echo "Trigger: $EVENT_NAME"
          echo "CHANGELOG reset: $CHANGELOG_RESET"
          echo "Sync branch pushed: $SYNC_PUSHED"
          echo "PR number: $PR_NUMBER"
